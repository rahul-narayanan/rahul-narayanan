SELECT
    (
        SELECT
            c.client_id,
            client_name,
            is_company_admin,
            (
                SELECT
                    DISTINCT p.product_name,
                    (
                        SELECT
                            DISTINCT pr_outer.product_role_id,
                            pr_outer.product_role_name,
                            (
                                SELECT
                                    DISTINCT da.data_asset_view_name
                                FROM
                                    user_entitlement ue
                                LEFT JOIN
                                    entitlement_group eg ON eg.entitlement_group_id = ue.entitlement_group_id
                                LEFT JOIN
                                    product_role pr ON eg.product_role_id = pr.product_role_id
                                LEFT JOIN
                                    data_asset da ON pr.product_role_id = da.product_role_id
                                WHERE
                                    ue.user_id = u.user_id
                                    AND pr.product_role_id = pr_outer.product_role_id
                                    AND ucm.companyCompanyId = c.company_id
                                    AND da.data_asset_view_name IS NOT NULL
                                FOR JSON AUTO
                            ) AS data_assets
                        FROM
                            user_entitlement ue
                        LEFT JOIN
                            entitlement_group eg ON eg.entitlement_group_id = ue.entitlement_group_id
                        LEFT JOIN
                            product_role pr ON eg.product_role_id = pr.product_role_id
                        LEFT JOIN
                            product p ON pr.product_id = p.product_id
                        WHERE
                            ue.user_id = u.user_id
                            AND ucm.companyCompanyId = c.company_id
                        FOR JSON AUTO
                    ) AS products
                FROM
                    user_entitlement ue_outer
                LEFT JOIN
                    entitlement_group eg_outer ON eg_outer.entitlement_group_id = ue_outer.entitlement_group_id
                LEFT JOIN
                    product_role pr_outer ON eg_outer.product_role_id = pr_outer.product_role_id
                LEFT JOIN
                    data_asset da_outer ON pr_outer.product_role_id = da_outer.product_role_id
                WHERE
                    ue_outer.user_id = u.user_id
                    AND ucm.companyCompanyId = c.company_id
                    AND da_outer.data_asset_view_name IS NOT NULL
                GROUP BY
                    pr_outer.product_role_id, pr_outer.product_role_name, da_outer.data_asset_view_name
                FOR JSON AUTO
            ) AS products
        FROM
            user_company_mapping ucm
        LEFT JOIN
            company c ON ucm.companyCompanyId = c.company_id
        WHERE
            ucm.userUserId = u.user_id
        FOR JSON AUTO
    ) AS clientsBreakdownData,
    (
        SELECT
            DISTINCT client_id,
            client_name,
            is_company_admin
        FROM
            user_company_mapping ucm
        LEFT JOIN
            company c ON ucm.companyCompanyId = c.company_id
        WHERE
            ucm.userUserId = u.user_id
        FOR JSON AUTO
    ) AS clientsList,
    (
        SELECT
            DISTINCT p.product_name
        FROM
            user_entitlement ue
        LEFT JOIN
            entitlement_group eg ON eg.entitlement_group_id = ue.entitlement_group_id
        LEFT JOIN
            product_role pr ON eg.product_role_id = pr.product_role_id
        LEFT JOIN
            product p ON pr.product_id = p.product_id
        WHERE
            ue.user_id = u.user_id
        FOR JSON AUTO
    ) AS products,
    (
        SELECT
            DISTINCT pr_outer.product_role_name,
            (
                SELECT
                    DISTINCT da.data_asset_view_name
                FROM
                    user_entitlement ue
                LEFT JOIN
                    entitlement_group eg ON eg.entitlement_group_id = ue.entitlement_group_id
                LEFT JOIN
                    product_role pr ON eg.product_role_id = pr.product_role_id
                LEFT JOIN
                    data_asset da ON pr.product_role_id = da.product_role_id
                WHERE
                    ue.user_id = u.user_id
                    AND pr.product_role_id = pr_outer.product_role_id
                    AND da.data_asset_view_name IS NOT NULL
                FOR JSON AUTO
            ) AS data_assets
        FROM
            user_entitlement ue_outer
        LEFT JOIN
            entitlement_group eg_outer ON eg_outer.entitlement_group_id = ue_outer.entitlement_group_id
        LEFT JOIN
            product_role pr_outer ON eg_outer.product_role_id = pr_outer.product_role_id
        LEFT JOIN
            data_asset da_outer ON pr_outer.product_role_id = da_outer.product_role_id
        WHERE
            ue_outer.user_id = u.user_id
            AND da_outer.data_asset_view_name IS NOT NULL
        GROUP BY
            pr_outer.product_role_id, pr_outer.product_role_name, da_outer.data_asset_view_name
        FOR JSON AUTO
    ) AS productRoles
FROM
    [user] u
WHERE
    u.user_email = 'aries.testuser@testcomp.com'
FOR JSON PATH








SELECT
    c.client_id,
    c.client_name,
    ucm.is_company_admin,
    (
        SELECT DISTINCT
            p.product_name,
            (
                SELECT DISTINCT
                    pr_outer.product_role_name,
                    (
                        SELECT DISTINCT
                            da.data_asset_view_name
                        FROM
                            user_entitlement ue
                        LEFT JOIN
                            entitlement_group eg ON eg.entitlement_group_id = ue.entitlement_group_id
                        LEFT JOIN
                            product_role pr ON eg.product_role_id = pr.product_role_id
                        LEFT JOIN
                            data_asset da ON pr.product_role_id = da.product_role_id
                        WHERE
                            ue.user_id = u.user_id
                            AND c.company_id = ucm.companyCompanyId
                            AND p.product_id = pr_outer.product_role_id
                            AND da.data_asset_view_name IS NOT NULL
                        FOR JSON AUTO
                    ) AS data_assets
                FROM
                    user_entitlement ue_outer
                LEFT JOIN
                    entitlement_group eg_outer ON eg_outer.entitlement_group_id = ue_outer.entitlement_group_id
                LEFT JOIN
                    product_role pr_outer ON eg_outer.product_role_id = pr_outer.product_role_id
                WHERE
                    ue_outer.user_id = u.user_id
                    AND c.company_id = ucm.companyCompanyId
                    AND p.product_id = pr_outer.product_role_id
                FOR JSON AUTO
            ) AS product_roles
        FROM
            product p
        LEFT JOIN
            user_entitlement ue ON ue.user_id = u.user_id
        LEFT JOIN
            entitlement_group eg ON eg.entitlement_group_id = ue.entitlement_group_id
        LEFT JOIN
            product_role pr ON eg.product_role_id = pr.product_role_id
        WHERE
            c.company_id = ucm.companyCompanyId
            AND p.product_id = pr.product_role_id
            AND p.product_name IS NOT NULL
        FOR JSON AUTO
    ) AS products
FROM
    user_company_mapping ucm
LEFT JOIN
    company c ON ucm.companyCompanyId = c.company_id
WHERE
    ucm.userUserId = u.user_id
FOR JSON PATH



(
        SELECT
            ag.group_name,
            (
                SELECT
                    a.account_number
                FROM
                    account a
                JOIN
                    group_account_type_mapping agm ON a.account_number = agm.accountNumber
                WHERE
                    agm.groupId = ag.group_id
                FOR JSON AUTO
            ) AS account_numbers
        FROM
            user_group_mapping ugm
        JOIN
            [group] ag ON ugm.groupId = ag.group_id
        WHERE
            ugm.user_id = u.user_id
            AND c.company_id = ucm.companyCompanyId
        FOR JSON AUTO
    ) AS accountGroups
