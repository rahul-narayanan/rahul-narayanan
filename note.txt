import { Company } from './company.entity';

@EntityRepository(Company)
export class CompanyRepository extends Repository<Company> {
  async getCompaniesWithCounts(): Promise<Company[]> {
    return this.createQueryBuilder('company')
      .addSelect((subQuery) => {
        subQuery
          .select('COUNT(user.id)', 'userCount')
          .from('user', 'user')
          .where('user.companyId = company.id');
      }, 'userCount')
      .addSelect((subQuery) => {
        subQuery
          .select('COUNT(account.id)', 'accountCount')
          .from('account', 'account')
          .where('account.companyId = company.id');
      }, 'accountCount')
      .addSelect((subQuery) => {
        subQuery
          .select('COUNT(group.id)', 'groupCount')
          .from('group', 'group')
          .where('group.companyId = company.id');
      }, 'groupCount')
      .getRawMany();
  }
}
